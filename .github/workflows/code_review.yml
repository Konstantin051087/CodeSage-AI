name: CodeSage Review

on:
  pull_request:
    paths:
      - '**.py'

# üîë –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ PR
permissions:
  contents: read
  pull-requests: write

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
      
      - name: Install CodeSage
        run: |
          pip install -r requirements.txt
          pip install .
      
      - name: Run Analysis
        run: |
          codesage --path . --output report.md
        continue-on-error: true  # –ü—Ä–æ–¥–æ–ª–∂–∞—Ç—å –¥–∞–∂–µ –µ—Å–ª–∏ –∞–Ω–∞–ª–∏–∑ –Ω–∞—à—ë–ª —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –∏–ª–∏ —É–ø–∞–ª
      
      - name: Comment PR
        if: always()  # ‚Üê –í–ê–ñ–ù–û: –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –í–°–ï–ì–î–ê, –¥–∞–∂–µ –µ—Å–ª–∏ —à–∞–≥–∏ –≤—ã—à–µ —É–ø–∞–ª–∏
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'report.md';
            let body;
            if (fs.existsSync(path)) {
              body = fs.readFileSync(path, 'utf8');
            } else {
              body = "**‚ö†Ô∏è CodeSage failed to generate a report.**\n\n" +
                     "Possible reasons:\n" +
                     "- CLI crashed (check 'Run Analysis' logs),\n" +
                     "- No Python files found,\n" +
                     "- Unhandled exception in detector or reporter.\n\n" +
                     "üîç Please review the workflow logs for details.";
            }
            // GitHub API –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –¥–ª–∏–Ω—É –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body.substring(0, 65535)
            });